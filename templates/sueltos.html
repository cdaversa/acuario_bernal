{% extends "layout.html" %}
{% block title %}Productos Sueltos{% endblock %}
{% block content %}
<h2>🐾 Productos Sueltos</h2>


<!-- ✅ BOTONES DE IMPORTAR / EXPORTAR -->
<div class="mb-3">
  <a href="{{ url_for('exportar_sueltos') }}" class="btn btn-outline-primary">📤 Exportar Excel</a>
</div>

<form action="{{ url_for('importar_sueltos') }}" method="post" enctype="multipart/form-data" class="mb-4">
  <div class="input-group">
    <input type="file" name="archivo_sueltos" class="form-control" accept=".xlsx" required>
    <button class="btn btn-outline-success">📥 Importar Excel</button>
  </div>
</form>

<!-- Formulario para agregar nuevo suelto -->
<h4 class="mt-4">➕ Agregar Nuevo Producto Suelto</h4>
<form action="{{ url_for('sueltos') }}" method="post" class="row g-3 mb-4">
  <div class="col-md-4"><input type="text" name="nombre" class="form-control" placeholder="Nombre" required></div>
  <div class="col-md-3"><input type="text" name="precio" class="form-control" placeholder="Precio" required></div>
  <div class="col-md-3">
    <select name="categoria" class="form-select" required>
      <option value="perro">Perro</option>
      <option value="gato">Gato</option>
      <option value="piedras">Piedras</option>
    </select>
  </div>
  <div class="col-md-2"><button class="btn btn-success w-100">➕ Agregar</button></div>
</form>

<!-- ✅ Campo de búsqueda -->
<h4 class="mt-4">🔍 Buscar Productos Sueltos</h4>
<input type="text" id="buscador_sueltos" class="form-control mb-3" placeholder="🔍 Buscar producto suelto...">

<!-- ✅ Contenedor de todas las tablas -->
<div id="tabla-sueltos">
{% for categoria, lista in {'Perro':perros, 'Gato':gatos, 'Piedras':piedras}.items() %}
  <div class="categoria-block">
    <h3 class="mt-4">{{ categoria }}</h3>
    <table class="table table-bordered">
      <thead><tr><th>Producto</th><th>Precio</th><th>Acciones</th></tr></thead>
      <tbody>
      {% for p in lista %}
        <tr>
          <td>{{ p['nombre'] }}</td>
          <td>{{ p['precio']|precio }}</td>
          <td>
            <form action="{{ url_for('editar_suelto', id=p['id']) }}" method="post" class="d-inline">
              <input type="hidden" name="nombre" value="{{ p['nombre'] }}">
              <input type="hidden" name="precio" value="{{ p['precio'] }}">
              <input type="hidden" name="categoria" value="{{ p['categoria'] }}">
              <button class="btn btn-primary btn-sm">💾 Editar</button>
            </form>
            <a href="{{ url_for('eliminar_suelto_ruta', id=p['id']) }}" class="btn btn-danger btn-sm" onclick="return confirm('¿Eliminar?')">🗑</a>
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
{% endfor %}
</div>

<script>
// ✅ Buscador en tiempo real (corrige problemas de filtrado)
document.getElementById("buscador_sueltos").addEventListener("keyup", function () {
    let filtro = this.value.toLowerCase();

    // Recorremos todas las categorías
    document.querySelectorAll("#tabla-sueltos .categoria-block").forEach(bloque => {
        let filas = bloque.querySelectorAll("tbody tr");
        let hayCoincidencia = false;

        filas.forEach(row => {
            let texto = row.innerText.toLowerCase();
            if (texto.includes(filtro) || filtro === "") {
                row.style.display = "";
                hayCoincidencia = true;
            } else {
                row.style.display = "none";
            }
        });

        // Ocultar título y tabla si no hay resultados
        bloque.style.display = hayCoincidencia ? "" : "none";
    });
});
</script>

{% endblock %}
